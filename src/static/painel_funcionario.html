<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Funcionário</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #fff;
      color: #333;
      position: relative;
      min-height: 100vh;
    }

    h1, h2 {
      margin-bottom: 20px;
    }

    .search-container {
      margin-bottom: 30px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .search-container input[type="text"] {
      padding: 10px;
      width: 300px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .search-container button {
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    .search-container button:hover {
      background-color: #0056b3;
    }

    #results-container {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .cliente-card {
      background-color: #fefefe;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .pet-info {
      margin-left: 20px;
      border-left: 3px solid #007bff;
      padding-left: 15px;
    }

    #agendamentos {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .card {
      background-color: #fefefe;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .excluir-btn {
      background-color: #dc3545;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      margin-top: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .excluir-btn:hover {
      background-color: #a71d2a;
    }

    .btn-sair {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background-color: #333;
      color: #fff;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
    }

    .secao-vendas { 
      display: flex; 
      gap: 20px; 
      padding: 15px; 
      border-top: 2px solid #000; 
      margin-top: 20px;
    }
    .secao-vendas .painel { 
      flex: 1; 
      padding: 15px; 
      border: 1px solid #ccc; 
      border-radius: 8px; 
    }
    .secao-vendas #lista-produtos .item, .secao-vendas #carrinho .item { 
      display: flex; 
      justify-content: 
      space-between; padding: 8px; 
      border-bottom: 1px solid #eee; 
    }
    .secao-vendas #carrinho .item button { 
      background-color: #ff4d4d; 
      color: white; 
      border: none; 
      cursor: pointer; 
    }
    .secao-vendas #total-venda { 
      font-size: 1.2em; 
      font-weight: bold; 
      margin-top: 15px; 
      text-align: right;
    }
  </style>
</head>
<body>

  <a class="btn-sair" href="/logout">Sair</a>

  <h1>Painel do Funcionário</h1>
  <p>Busque clientes por nome ou CPF para visualizar seus dados e de seus pets.</p>

  <div class="search-container">
    <form id="search-form">
      <input type="text" id="search-term" name="termo" placeholder="Digite o nome ou CPF do cliente" required>
      <button type="submit">Buscar</button>
    </form>
  </div>

  <h2>Agendamentos</h2>
  <label for="filtro-data">Filtrar por data:</label>
  <input type="date" id="filtro-data">
  <button onclick="carregarAgendamentos()">Filtrar</button>

  <div id="agendamentos"></div>

  <hr>

  <div id="results-container"></div>

  <div class="secao-vendas">
        <div class="painel">
            <h3>Registrar Venda de Produtos</h3>
            <input type="text" id="busca-produto-venda" placeholder="Buscar produto..." style="width: 95%;">
            <div id="lista-produtos-venda" style="height: 300px; overflow-y: auto; margin-top: 10px;"></div>
        </div>

        <div class="painel">
            <h3>Carrinho</h3>
            <div id="carrinho-venda" style="height: 250px; overflow-y: auto;">
                <p>Nenhum item no carrinho.</p>
            </div>
            <div id="total-venda">Total: R$ 0.00</div>
            <hr>
            <input type="text" id="busca-cliente-cpf-venda" placeholder="CPF do Cliente (opcional)" style="width: 95%;">
            <br><br>
            <button onclick="finalizarVenda()">Finalizar Venda</button>
        </div>
    </div>

  <script>
    async function carregarAgendamentos() {
      const data = document.getElementById('filtro-data').value;
      let url = '/api/agendamentos/detalhes';
      if (data) url += `?data=${data}`;

      const res = await fetch(url);
      const agendamentos = await res.json();
      const container = document.getElementById('agendamentos');
      container.innerHTML = '';

      if (agendamentos.length === 0) {
        container.innerHTML = '<p>Nenhum agendamento encontrado.</p>';
        return;
      }

      agendamentos.forEach(ag => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <strong>Data:</strong> ${ag.data}<br>
          <strong>Hora:</strong> ${ag.hora}<br>
          <strong>Pet:</strong> ${ag.nome_pet}<br>
          <strong>Cliente:</strong> ${ag.nome_cliente}<br>
          <strong>Serviço:</strong> ${ag.nome_servico}<br>
          <button class="excluir-btn" data-id="${ag.id}">Excluir</button>
        `;
        container.appendChild(card);
      });

      document.querySelectorAll('.excluir-btn').forEach(btn => {
        btn.addEventListener('click', async function () {
          if (!confirm('Deseja realmente excluir este agendamento?')) return;
          const id = this.dataset.id;
          const fd = new FormData();
          fd.append('id', id);
          const res = await fetch('/api/excluir-agendamento', { method: 'POST', body: fd, credentials: 'include' });
          if (res.ok) carregarAgendamentos();
          else alert('Erro ao excluir agendamento.');
        });
      });
    }

    window.onload = carregarAgendamentos;

    document.getElementById('search-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const termo = document.getElementById('search-term').value;
      const rc = document.getElementById('results-container');
      rc.innerHTML = '<p>Buscando...</p>';

      try {
        const res = await fetch(`/api/buscar-clientes?termo=${encodeURIComponent(termo)}`);
        if (!res.ok) throw new Error(`Erro na busca: ${res.statusText}`);
        const data = await res.json();

        if (data.length === 0) {
          rc.innerHTML = '<p>Nenhum cliente encontrado.</p>';
          return;
        }

        rc.innerHTML = '';
        data.forEach(c => {
          const card = document.createElement('div');
          card.className = 'cliente-card';
          let petsHtml = '<h4>Pets:</h4>';

          if (c.pets.length > 0) {
            c.pets.forEach(p => {
              petsHtml += `
                <div class="pet-info">
                  <p><strong>Nome:</strong> ${p.nome_pet}</p>
                  <p><strong>Raça:</strong> ${p.raca_pet} | <strong>Idade:</strong> ${p.idade_pet} anos | <strong>Tipo:</strong> ${p.tipo_animal_pet}</p>
                </div>`;
            });
          } else {
            petsHtml += '<p>Nenhum pet cadastrado.</p>';
          }

          card.innerHTML = `
            <h2>${c.nome_cliente}</h2>
            <p><strong>CPF:</strong> ${c.cpf_cliente}</p>
            <p><strong>Contato:</strong> ${c.contato_cliente}</p>
            ${petsHtml}
          `;
          rc.appendChild(card);
        });
      } catch (err) {
        rc.innerHTML = `<p style="color:red;">${err.message}</p>`;
      }
    });

    let produtosDisponiveisVenda = [];
    let carrinhoVenda = [];

    async function carregarTodosProdutosParaVenda() {
      try {
        const res = await fetch('/api/produtos');
        if (!res.ok) throw new Error('Falha ao carregar produtos');
        produtosDisponiveisVenda = await res.json();
        filtrarProdutosVenda();
      } catch (error) {
        document.getElementById('lista-produto-vendas').innerHTML = `<p style="color:red;">${error.message}</p>`;
      }
    }

    function filtrarProdutosVenda(){
      const termoBusca = document.getElementById('busca-produto-venda').value.toLowerCase();
      const listaDiv = document.getElementById('lista-produtos-venda');
      listaDiv.innerHTML = '';

      const produtosFiltrados = produtosDisponiveisVenda.filter(p => p.nome.toLowerCase().includes(termoBusca) && p.estoque > 0);
      if (produtosFiltrados.length === 0){
        listaDiv.innerHTML = '<p>Nenhum produto encontrado ou com estoque.</p>';
        return;
      }
      produtosFiltrados.forEach(p => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.innerHTML = `
                    <span>${p.nome} (Estoque: ${p.estoque}) - R$ ${p.preco.toFixed(2)}</span>
                    <button onclick="adicionarAoCarrinhoVenda(${p.id})">+</button>
                `;
                listaDiv.appendChild(itemDiv);
            })
    }
    document.getElementById('busca-produto-venda').addEventListener('keyup', filtrarProdutosVenda);

        function adicionarAoCarrinhoVenda(produtoId) {
            const produto = produtosDisponiveisVenda.find(p => p.id === produtoId);
            const itemNoCarrinho = carrinhoVenda.find(item => item.id === produtoId);

            if (itemNoCarrinho) {
                if (itemNoCarrinho.quantidade < produto.estoque) {
                    itemNoCarrinho.quantidade++;
                } else {
                    alert('Quantidade máxima em estoque atingida.');
                }
            } else {
                carrinhoVenda.push({ ...produto, quantidade: 1 });
            }
            renderizarCarrinhoVenda();
        }

        function removerDoCarrinhoVenda(produtoId) {
            carrinhoVenda = carrinhoVenda.filter(item => item.id !== produtoId);
            renderizarCarrinhoVenda();
        }

        function renderizarCarrinhoVenda() {
            const carrinhoDiv = document.getElementById('carrinho-venda');
            const totalDiv = document.getElementById('total-venda');
            carrinhoDiv.innerHTML = '';
            let total = 0;

            if (carrinhoVenda.length === 0) {
                carrinhoDiv.innerHTML = '<p>Nenhum item no carrinho.</p>';
            } else {
                carrinhoVenda.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.innerHTML = `
                        <span>${item.nome} (Qtd: ${item.quantidade})</span>
                        <button onclick="removerDoCarrinhoVenda(${item.id})">x</button>
                    `;
                    carrinhoDiv.appendChild(itemDiv);
                    total += item.preco * item.quantidade;
                });
            }
            totalDiv.innerText = `Total: R$ ${total.toFixed(2)}`;
        }
        
        async function finalizarVenda() {
            if (carrinhoVenda.length === 0) {
                alert('O carrinho está vazio!');
                return;
            }

            const payload = {
                itens: carrinhoVenda,
                cpf_cliente: document.getElementById('busca-cliente-cpf-venda').value
            };

            const res = await fetch('/api/registrar-venda', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (res.ok) {
                alert(`Venda #${data.venda_id} registrada com sucesso!`);
                carrinhoVenda = [];
                renderizarCarrinhoVenda();
                carregarTodosProdutosParaVenda();
            } else {
                alert('Erro ao registrar a venda: ' + data.erro);
            }
        }

        window.onload = () => {
            carregarAgendamentos();
            carregarTodosProdutosParaVenda();
        };
  </script>

</body>
</html>
